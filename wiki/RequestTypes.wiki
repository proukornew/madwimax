#summary Описание типов запросов и ответов

= О форматах =

Формат передаваемых данных (и назначение этих данных) определяется вторым байтом данных. Первый байт всегда равен 0x57. Используется четыре формата (hex):

 * 43 - для конфигурирования устройства, передачи debug-сообщений
 * 44 - для передачи пользовательского сетевого траффика
 * 45 - при инициализации, для обмена информацией о возможностях USB хоста и устройства
 * 50 - при инициализации для получения MAC адреса устройства (также узнать его можно одним из запросов формата 43) и в случае отсутствия данных по запросу 43

= Подробное описание =

== 43 ==

См. [Format43 описание].

== 44 ==

Используется для передачи пользовательского сетевого траффика после установления соединения. Никак иначе траффик не передается.

Пример (DHCP пакет):

{{{
[1302764 ms]  >>>  URB 690 going down  >>>
    00000000: 57 44 6e 00 00 00 ff ff ff ff ff ff 00 21 d2 1e
    00000010: 61 6e 08 00 45 00 00 60 00 06 00 00 80 11 1a 5d
    00000020: 5e 19 b1 f8 5e 19 b1 ff 00 89 00 89 00 4c 65 7c
    00000030: 80 00 29 10 00 01 00 00 00 00 00 01 20 45 42 46
    00000040: 41 45 50 45 4d 45 4d 45 50 43 41 43 41 43 41 43
    00000050: 41 43 41 43 41 43 41 43 41 43 41 41 41 00 00 20
    00000060: 00 01 c0 0c 00 20 00 01 00 04 93 e0 00 06 00 00
    00000070: 5e 19 b1 f8
}}}

Первые 6 байт - заголовок, далее - стандартный [http://en.wikipedia.org/wiki/Ethernet_II_framing ethernet II кадр], полученный от сетевого интерфейса ОС или передаваемый ему.

Формат заголовка:

|| Байт || Значение || Пример ||
|| 0    || id протокола || 57 ||
|| 1    || id формата || 44 ||
|| 2-3  || длина данных без заголовка (LE) || 6e 00 ||
|| 4-5  || "мусор" || 00 00 ||

Следует отметить: если хост передает ARP пакет (тип вложенного в кадр пакета определяется байтами 0xc-0xd кадра, в случае ARP это 0x0806, в случае IPv4 пакета - 0x0800, как в примере), то Windows драйвер обрабатывает его особо и устройству не передает. Поэтому, в логах его нет, но драйвер обязан делать такую же обработку. [http://www.iana.org/assignments/ethernet-numbers Подробнее о номерах форматов].

== 45 ==

Используется при инициализации, для обмена информацие о возможностях USB хоста и устройства. Фактически это 2 самых первых обмена.

Пример:

{{{
[93 ms]  >>>  URB 5 going down  >>>
    00000000: 57 45 04 00 00 02 00 74
[93 ms]  <<<  URB 5 coming back  <<<
[93 ms]  >>>  URB 6 going down  >>>
[105 ms]  <<<  URB 6 coming back  <<<
    00000000: 57 45 0e 00 00 03 00 33 ff ff ff ff ff ff ff ff
    00000010: 15 0b
}}}

Формат:

|| Байт || Значение || Пример ||
|| 0    || id протокола || 57 ||
|| 1    || id формата || 45 ||
|| 2-3  || длина оставшихся данных (LE) || 04 00 ||
|| 4-5  || длина оставшихся данных (BE) || 00 02 ||
|| 6    || hard-coded || 00 ||
|| 7    || байт флагов || 74 ||

Флаги по битовым маскам:

|| Бит  || Значение ||
|| 0x01 || USB_HOST_SUPPORT_EXTENDED_CMD ||
|| 0x02 || USB_HOST_SUPPORT_MULTIPLE_MAC_REQ ||
|| 0x04 || USB_HOST_SUPPORT_SELECTIVE_SUSPEND ||
|| 0x08 || USB_HOST_SUPPORT_TRUNCATE_ETHERNET_HEADER ||
|| 0x10 || USB_HOST_SUPPORT_DL_SIX_BYTES_HEADER ||
|| 0x20 || USB_HOST_SUPPORT_UL_SIX_BYTES_HEADER ||
|| 0x40 || USB_HOST_SUPPORT_DL_MULTI_PACKETS ||
|| 0x80 || USB_HOST_SUPPORT_UL_MULTI_PACKETS ||

== 50 ==

Используется при инициализации для получения MAC адреса устройства (также узнать его можно одним из запросов формата 43) и в случае отсутствия данных по запросу 43 (например, когда запрашивается поиск сети, но сеть не обнаруживается).